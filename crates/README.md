# <img src="./emdb/docs/logo.drawio.svg" alt="emDB" style="vertical-align: middle;" title="emdb logo" width="100"/> Crates
This workspace contains the usable libraries from <img src="./emdb/docs/logo.drawio.svg" alt="emDB" style="vertical-align: middle;" title="emdb logo" width="50"/>.

## Setup
### Basic Development
1. [Get rust](https://www.rust-lang.org/tools/install)
2. Use [cargo](https://doc.rust-lang.org/cargo/) in this directory to build, test, benchmark and create docs
3. Get an IDE supporting rust analyzer (vscode, [rustrover](https://www.jetbrains.com/rust/), clion, zed, nvim, etc. )

### Additional Tools
A basic toolchain is setup ayutomatically when running `cargo` by [`./rust-toolchain.toml`](./rust-toolchain.toml), however some useful tools to additionally install are...
#### [`cargo install cargo-expand`](https://github.com/dtolnay/cargo-expand)
Expands procedural macros and outputs highlighted expansion to the terminal.
```bash
cd emdb
cargo expand --test scratch
```

#### [`cargo install cargo-show-asm`](https://github.com/pacak/cargo-show-asm)
View intermediate results (mir, llvm, asm) generated by rustc. Allows easy scoping down to the level of individual functions.
```bash
# view the available objects in the dereferencing example
cargo asm -p emdb --example dereferencing

# for the 2nd object option
cargo asm -p emdb --example dereferencing --mir 1 # view the MIR code
cargo asm -p emdb --example dereferencing --mca 1 # view the llvm mca analysis
```

#### [`cargo install flamegraph`](https://github.com/flamegraph-rs/flamegraph)
Generates flame graphs using `perf`, from tests and benchmarks. 
```bash
CARGO_PROFILE_BENCH_DEBUG=true cargo flamegraph -p combi --bench tokens
```

## Develop
### Workspace
All crates part of this project are contained in a single [cargo workspace](https://doc.rust-lang.org/book/ch14-03-cargo-workspaces.html).
- *Beware: The project relies on a [fork of divan](https://github.com/OliverKillane/divan) for benchmarks from outside this repo*

```bash
cargo test
cargo bench
```

### Lockfile
[`Cargo.lock`](./Cargo.lock) is tracked by version control for reproducability ([see this justification](https://doc.rust-lang.org/cargo/faq.html#why-have-cargolock-in-version-control)).

### Documentation
```bash
cargo doc                          # public docs
cargo doc --document-private-items # include private documentation
```

If using vscode, the [live preview](vscode:extension/ms-vscode.live-server) can 
be used to view documentation built in the [target directory](../target/doc/emdb/).

## Other Resources
### [Rust Performance Book](https://nnethercote.github.io/perf-book/introduction.html)
